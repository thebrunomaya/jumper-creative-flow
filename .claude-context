# Claude Code Context File
# Auto-managed by Claude Code sessions
# Tracks recent decisions and work-in-progress (last 7 days)
# Older decisions migrate to docs/ARCHITECTURE.md

last_updated: "2025-10-09T20:30:00Z"
session_computer: "MacBook Pro (trabalho)"
session_user: "Bruno Maya"

# Recent decisions (last 7 days)
# When older than 7 days, migrate to docs/ARCHITECTURE.md
recent_decisions:
  - date: "2025-10-09"
    decision: "Using j_ads_users for user management"
    status: "implemented"
    details: |
      - Table: j_ads_users (id, email, role, nome, notion_manager_id)
      - Roles: 'admin', 'staff', 'client'
      - Deleted: user_roles, j_ads_user_roles (obsolete)
      - Edge functions must use j_ads_users.role for permission checks
    impact: "High - Affects all authentication and authorization logic"
    migrate_to_architecture: false

  - date: "2025-10-09"
    decision: "Fixed inactive accounts filter and cleaned obsolete migrations"
    status: "completed ✅"
    details: |
      - Fixed filter to use 'Inativo' (masculine) instead of 'inativa'
      - Resolved has_role() function conflict (removed app_role version)
      - Added RLS policies for j_ads_notion_db_managers
      - Fixed 406 error with .maybeSingle() in AuthContext
      - Deleted 10 obsolete migrations (n8n_*, old accounts tables)
      - Created new migrations with proper naming convention
      - Removed "X de Y contas" badge from UI
    impact: "Medium - Improved filtering and database cleanup"
    migrate_to_architecture: false

# Current issues being worked on
current_issues:
  - issue: "Nome de bruno@jumper.studio vazio na j_ads_users"
    severity: "medium"
    discovered: "2025-10-09"
    root_cause: "OAuth users não têm nome populado automaticamente"
    next_steps:
      - "Popular nome usando auth.users metadata (user_metadata.full_name)"
      - "Criar migration para sync automático no login"
    assigned_to: "pending"

  - issue: "Só 1 conta aparece em Minhas Contas (deveria mostrar todas)"
    severity: "high"
    discovered: "2025-10-09"
    root_cause: "Edge function j_ads_user_accounts usando user_roles (não existe)"
    status: "FIXED ✅"
    fixed_at: "2025-10-09T18:15:00Z"
    solution: |
      - Corrigido para usar j_ads_users.role ao invés de user_roles
      - Implementada busca por notion_manager_id para clients
      - Melhorada resolução de nomes via j_ads_users
      - Lógica separada por role: admin (all) / staff (email) / client (notion_manager_id)
    deployed: true

# Work in progress
work_in_progress:
  - task: "Sistema de Minhas Contas - Hierarquia de badges e ordenação"
    branch: "main"
    started: "2025-10-09"
    completed: "2025-10-09T18:15:00Z"
    status: "COMPLETED ✅"
    files_modified:
      - "supabase/functions/j_ads_user_accounts/index.ts"
      - "src/pages/MyAccounts.tsx"
      - "src/components/AccountCard.tsx"
      - "src/hooks/useMyNotionAccounts.ts"
      - ".claude-context" (NEW - context management)
      - "docs/ARCHITECTURE.md" (UPDATED - j_ads_users documentation)
      - "CLAUDE.md" (UPDATED - session protocols)
    deployed: true
    deployment_status: "WORKING ✅ - uses j_ads_users correctly"

# Context for next session
next_session_context: |
  ✅ SESSION 2025-10-10 COMPLETED: Database Cleanup Planning

  What was done today:
    - ✅ Complete database audit (20 tables identified)
    - ✅ Identified 7 obsolete tables to remove
    - ✅ Updated CLAUDE.md with j_rep_metaads_bronze documentation
    - ✅ Created migration: 20251010000000_cleanup_obsolete_tables.sql
    - ✅ Created migration: 20251010000001_add_rls_metaads_bronze.sql
    - ✅ Plan documented and ready for execution

  🚨 CRITICAL TASK FOR NEXT SESSION: Execute Database Cleanup

  DATABASE STATE (20 tables total):

  ✅ KEEP (14 tables):
    - j_ads_creative_files/submissions/variations
    - j_ads_error_logs, j_ads_metrics
    - j_ads_notion_db_accounts/managers
    - j_ads_notion_sync_logs
    - j_ads_optimization_* (4 tables)
    - j_ads_users
    - j_rep_metaads_bronze ⚠️ (needs RLS!)

  ❌ REMOVE (7 tables):
    - creative_files, creative_submissions, creative_variations (duplicatas)
    - notion_managers, notion_manager_accounts (antigas)
    - user_roles (antiga)
    - videosmmx (se existir - verificar)

  EXECUTION PLAN (next session):

  🔍 PHASE 1: Verify Code References (5 min)
    ```bash
    # Check for obsolete table usage
    grep -r "FROM creative_submissions\|FROM creative_files" supabase/ src/
    grep -r "notion_managers\|user_roles" supabase/ src/
    ```
    → If found: update to j_ads_* before proceeding
    → If not found: proceed to Phase 2

  🗑️ PHASE 2: Apply Cleanup Migration (2 min)
    ```bash
    npx supabase db push --linked
    ```
    → Applies: 20251010000000_cleanup_obsolete_tables.sql
    → Removes: 6 obsolete tables

  🔐 PHASE 3: Apply RLS Migration (2 min)
    ```bash
    # Already applied in Phase 2 (same push)
    ```
    → Applies: 20251010000001_add_rls_metaads_bronze.sql
    → Secures: j_rep_metaads_bronze with RLS

  🔄 PHASE 4: Regenerate Types (1 min)
    ```bash
    npx supabase gen types typescript --linked > src/integrations/supabase/types.ts
    ```
    → Should show only 14 tables (j_ads_* + j_rep_*)

  ✅ PHASE 5: Validation (5 min)
    - Check table count: should be 14
    - Test MyAccounts page: should work
    - Test Reports dashboards: should respect RLS
    - Commit changes

  SECURITY FIX INCLUDED:
    ⚠️ j_rep_metaads_bronze currently has NO RLS
    ✅ Migration adds RLS policies:
       - Users see only their account data
       - Admins see all data
       - Staff see managed accounts
       - Clients see assigned accounts

  Known issues (non-blocking):
    - User name still shows email in cards (cosmetic)

  All planning completed, ready for execution! ✅

# TODOs pending
pending_todos:
  - "🚨 PHASE 1: Verify code references to obsolete tables (grep creative_submissions, notion_managers, user_roles)"
  - "🚨 PHASE 2: Apply cleanup migration (npx supabase db push --linked)"
  - "🚨 PHASE 3: RLS already included in Phase 2 push"
  - "🚨 PHASE 4: Regenerate types.ts (npx supabase gen types)"
  - "🚨 PHASE 5: Validate and test (14 tables, RLS working, commit)"
  - "Populate nome field for bruno@jumper.studio in j_ads_users (optional)"

# Recently completed (for reference)
completed_recently:
  - "Created AccountCard component with role-based badges"
  - "Implemented getAccessReason() logic for badge assignment"
  - "Added sorting by access priority in MyAccounts.tsx"
  - "Created migration 20251008214802_setup_admin_role.sql (OBSOLETE - delete later)"

# Deployment status
deployment:
  production_url: "https://ads.jumper.studio"
  last_deploy: "2025-10-09T20:30:00Z"
  last_deploy_status: "success ✅"
  last_commit: "ca86613 - feat: fix inactive accounts filter, admin role detection, and cleanup migrations"
  edge_functions_deployed:
    - name: "j_ads_user_accounts"
      status: "working ✅"
      fix: "now uses j_ads_users.role correctly"
      deployed_at: "2025-10-09T18:15:00Z"
  migrations_pending: []
  migrations_applied_last: "20251009190000_create_error_tracking.sql"
  migrations_deleted: "10 obsolete migrations (n8n, old accounts)"

# Notes for context rotation
context_rotation:
  last_rotation: "never"
  next_rotation: "2025-10-16"
  items_to_migrate: []
