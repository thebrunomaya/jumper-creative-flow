# Claude Code Context File
# Auto-managed by Claude Code sessions
# Tracks recent decisions and work-in-progress (last 7 days)
# Older decisions migrate to docs/ARCHITECTURE.md

last_updated: "2025-10-09T20:30:00Z"
session_computer: "MacBook Pro (trabalho)"
session_user: "Bruno Maya"

# Recent decisions (last 7 days)
# When older than 7 days, migrate to docs/ARCHITECTURE.md
recent_decisions:
  - date: "2025-10-09"
    decision: "Using j_ads_users for user management"
    status: "implemented"
    details: |
      - Table: j_ads_users (id, email, role, nome, notion_manager_id)
      - Roles: 'admin', 'staff', 'client'
      - Deleted: user_roles, j_ads_user_roles (obsolete)
      - Edge functions must use j_ads_users.role for permission checks
    impact: "High - Affects all authentication and authorization logic"
    migrate_to_architecture: false

  - date: "2025-10-09"
    decision: "Fixed inactive accounts filter and cleaned obsolete migrations"
    status: "completed âœ…"
    details: |
      - Fixed filter to use 'Inativo' (masculine) instead of 'inativa'
      - Resolved has_role() function conflict (removed app_role version)
      - Added RLS policies for j_ads_notion_db_managers
      - Fixed 406 error with .maybeSingle() in AuthContext
      - Deleted 10 obsolete migrations (n8n_*, old accounts tables)
      - Created new migrations with proper naming convention
      - Removed "X de Y contas" badge from UI
    impact: "Medium - Improved filtering and database cleanup"
    migrate_to_architecture: false

# Current issues being worked on
current_issues:
  - issue: "Nome de bruno@jumper.studio vazio na j_ads_users"
    severity: "medium"
    discovered: "2025-10-09"
    root_cause: "OAuth users nÃ£o tÃªm nome populado automaticamente"
    next_steps:
      - "Popular nome usando auth.users metadata (user_metadata.full_name)"
      - "Criar migration para sync automÃ¡tico no login"
    assigned_to: "pending"

  - issue: "SÃ³ 1 conta aparece em Minhas Contas (deveria mostrar todas)"
    severity: "high"
    discovered: "2025-10-09"
    root_cause: "Edge function j_ads_user_accounts usando user_roles (nÃ£o existe)"
    status: "FIXED âœ…"
    fixed_at: "2025-10-09T18:15:00Z"
    solution: |
      - Corrigido para usar j_ads_users.role ao invÃ©s de user_roles
      - Implementada busca por notion_manager_id para clients
      - Melhorada resoluÃ§Ã£o de nomes via j_ads_users
      - LÃ³gica separada por role: admin (all) / staff (email) / client (notion_manager_id)
    deployed: true

# Work in progress
work_in_progress:
  - task: "Sistema de Minhas Contas - Hierarquia de badges e ordenaÃ§Ã£o"
    branch: "main"
    started: "2025-10-09"
    completed: "2025-10-09T18:15:00Z"
    status: "COMPLETED âœ…"
    files_modified:
      - "supabase/functions/j_ads_user_accounts/index.ts"
      - "src/pages/MyAccounts.tsx"
      - "src/components/AccountCard.tsx"
      - "src/hooks/useMyNotionAccounts.ts"
      - ".claude-context" (NEW - context management)
      - "docs/ARCHITECTURE.md" (UPDATED - j_ads_users documentation)
      - "CLAUDE.md" (UPDATED - session protocols)
    deployed: true
    deployment_status: "WORKING âœ… - uses j_ads_users correctly"

# Context for next session
next_session_context: |
  âœ… SESSION 2025-10-09 COMPLETED: Inactive filter + Database cleanup

  What was done today:
    - âœ… Fixed inactive accounts filter ('Inativo' working correctly)
    - âœ… Resolved has_role() function conflict (dropped app_role version)
    - âœ… Added RLS policies for j_ads_notion_db_managers
    - âœ… Fixed 406 error with .maybeSingle() in AuthContext
    - âœ… Cleaned 10 obsolete migrations (n8n, old accounts, etc)
    - âœ… Removed "X de Y contas" badge from UI
    - âœ… All changes committed and pushed to main (commit ca86613)

  System status:
    - Admin toggle: Working âœ…
    - Inactive filter: Working âœ… (43 â†’ 25 accounts)
    - Role detection: Working âœ…
    - MyAccounts page: Fully functional âœ…

  ðŸš¨ CRITICAL TASK FOR NEXT SESSION:

    Database Cleanup Audit
    ----------------------
    Bruno identified that there are obsolete tables still in Supabase database.

    Action plan:
    1. List all tables in Supabase (psql or dashboard)
    2. Search entire codebase for references to obsolete tables
    3. Find patterns: n8n_*, old 'accounts', 'notion_managers', 'user_roles'
    4. Replace old references with j_ads_* tables
    5. Drop obsolete tables from database

    Expected: Only j_ads_* tables should exist
    Actual: Unknown - needs audit

    This is important for:
    - Reducing database clutter
    - Preventing accidental use of old tables
    - Clear separation of concerns
    - Avoiding future confusion

  Known issues (non-blocking):
    - User name still shows email in cards (bruno@jumper.studio vs "Bruno Maya")
    - This is cosmetic, can be addressed later

  All changes deployed and working in production âœ…

# TODOs pending
pending_todos:
  - "ðŸš¨ CRITICAL: Database cleanup - Audit all tables, find obsolete references, drop old tables"
  - "ðŸš¨ Search codebase for references to: n8n_*, accounts (old), notion_managers, user_roles"
  - "Populate nome field for bruno@jumper.studio in j_ads_users (optional)"
  - "Test account filtering for admin/staff/client roles"

# Recently completed (for reference)
completed_recently:
  - "Created AccountCard component with role-based badges"
  - "Implemented getAccessReason() logic for badge assignment"
  - "Added sorting by access priority in MyAccounts.tsx"
  - "Created migration 20251008214802_setup_admin_role.sql (OBSOLETE - delete later)"

# Deployment status
deployment:
  production_url: "https://ads.jumper.studio"
  last_deploy: "2025-10-09T20:30:00Z"
  last_deploy_status: "success âœ…"
  last_commit: "ca86613 - feat: fix inactive accounts filter, admin role detection, and cleanup migrations"
  edge_functions_deployed:
    - name: "j_ads_user_accounts"
      status: "working âœ…"
      fix: "now uses j_ads_users.role correctly"
      deployed_at: "2025-10-09T18:15:00Z"
  migrations_pending: []
  migrations_applied_last: "20251009190000_create_error_tracking.sql"
  migrations_deleted: "10 obsolete migrations (n8n, old accounts)"

# Notes for context rotation
context_rotation:
  last_rotation: "never"
  next_rotation: "2025-10-16"
  items_to_migrate: []
