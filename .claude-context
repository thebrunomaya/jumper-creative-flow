# Claude Code Context File
# Auto-managed by Claude Code sessions
# Tracks recent decisions and work-in-progress (last 7 days)
# Older decisions migrate to docs/ARCHITECTURE.md

last_updated: "2024-11-05T22:00:00Z"
session_computer: "MacBook Pro (trabalho)"
session_user: "Bruno Maya"

# Recent decisions (last 7 days)
# When older than 7 days, migrate to docs/ARCHITECTURE.md
recent_decisions:
  - date: "2024-11-05"
    decision: "CRITICAL: Dual ID System Fix (UUID vs TEXT notion_id)"
    status: "completed âœ…"
    details: |
      ðŸš¨ CRITICAL BUG FIX: FK constraint violation on optimization creation resolved

      ## Session Summary (2024-11-05):

      ### 1. Problem Discovery

      **User Report:**
      "Claude, provavelmente em virtude dos ajustes que fizemos nessa sessÃ£o, quando tento criar uma nova otimizaÃ§Ã£o dÃ¡ erro permanente."

      **Error Message:**
      ```
      Error: insert or update on table "j_hub_optimization_recordings"
      violates foreign key constraint "j_ads_optimization_recordings_account_id_fkey"

      ReferenceError: selectedAccountName is not defined
      ```

      **Root Cause Investigation:**
      - Commit 412a8ec changed `j_hub_user_accounts` Edge Function to return UUIDs (for decks system)
      - `OptimizationNew.tsx` was storing UUID from `account.id`
      - `j_hub_optimization_recordings.account_id` is TEXT (expects `notion_id`)
      - UUID inserted into TEXT column â†’ FK constraint violation

      **Discovery: Dual ID System**
      - Modern tables (j_hub_decks) use UUID foreign keys
      - Legacy tables (j_hub_optimization_recordings) use TEXT notion_id foreign keys
      - `j_hub_user_accounts` now returns BOTH formats for compatibility

      ### 2. Fix Implementation (v2.0.75)

      **FIX 1: OptimizationNew.tsx (lines 109, 131)**
      ```typescript
      // Before: Stored UUID from PrioritizedAccountSelect
      setSelectedAccountId(accountId); // âŒ UUID in TEXT column

      // After: Extract notion_id from account object
      const account = accounts.find(a => a.id === accountId);
      setSelectedAccountId(account.notion_id); // âœ… TEXT in TEXT column
      ```

      Also fixed `handleRecoverDraft` to search by `a.notion_id` instead of `a.id`.

      **FIX 2: OptimizationRecorder.tsx (line 174)**
      ```typescript
      // Before: ReferenceError
      const accountNameSlug = selectedAccountName.replace(...); // âŒ undefined

      // After: Use correct prop name
      const accountNameSlug = accountName.replace(...); // âœ… defined prop
      ```

      ### 3. Architecture Documentation

      **Created comprehensive ARCHITECTURE.md section:**
      - Overview of dual ID system (UUID vs TEXT)
      - Table classification (Modern vs Legacy)
      - Edge Function compatibility layer
      - Frontend patterns and common mistakes
      - Incident report with symptoms/cause/fix
      - Migration strategy for future
      - Decision checklists

      **Location:** `docs/ARCHITECTURE.md` - "Dual ID System" section

      ### 4. Account Filtering Standardization

      **Problem:** Inconsistent account filtering across pages
      - `/optimization` showed ONLY accounts with optimizations (incorrect)
      - `/decks` had NO account filter
      - `/decks/new` used standard Select instead of PrioritizedAccountSelect

      **Solution:**
      - **PHASE 1:** Fixed `/optimization` to show ALL accessible accounts
      - **PHASE 2:** Added account filter to `/decks` using PrioritizedAccountSelect
      - **PHASE 3:** Migrated `/decks/new` to use PrioritizedAccountSelect

      **Result:** Unified account selection pattern across entire application

      ### 5. Navigation Headers Added

      **Problem:** Decks pages missing Header component

      **Fix:** Added Header and JumperBackground to:
      - `Decks.tsx` (panel view)
      - `DeckNew.tsx` (creation page)
      - `DeckEditor.tsx` (viewer page)

      **Result:** Consistent navigation across all pages

      ### 6. Git Commits

      **Commits Created:**
      ```
      e2a1aaa: fix: FK constraint violation on optimization creation (v2.0.74)
      9bac8c3: chore: bump version to v2.0.75
      ```

      **Files Changed:**
      - `src/pages/OptimizationNew.tsx` (handleAccountChange + handleRecoverDraft fixes)
      - `src/components/OptimizationRecorder.tsx` (selectedAccountName typo fix)
      - `src/config/version.ts` (version bump + changelog)
      - `docs/ARCHITECTURE.md` (new Dual ID System section, ~200 lines)

      ### 7. Context Organization

      **Migrated to ARCHITECTURE.md:**
      - Dual ID System architectural decision (permanent documentation)
      - Table classification and FK patterns
      - Frontend integration patterns

      **Cleaned up `.claude-context`:**
      - Removed decisions >7 days old (dev-setup agent, naming standardization)
      - Kept only recent work (last 3 days)
      - Updated deployment status

      ## Impact: CRITICAL - Production Bug Fix

      **Before:**
      - âŒ Creating new optimizations caused FK constraint errors
      - âŒ Inconsistent account filtering across pages
      - âŒ Missing navigation headers on decks pages

      **After:**
      - âœ… Optimization creation working correctly (v2.0.75 deployed)
      - âœ… Unified account selection pattern everywhere
      - âœ… Complete navigation across all pages
      - âœ… Comprehensive architecture documentation prevents future incidents

    impact: "CRITICAL - Fixed production bug + documented dual ID system architecture"
    files_changed:
      - "src/pages/OptimizationNew.tsx (UUID â†’ notion_id fix)"
      - "src/components/OptimizationRecorder.tsx (typo fix)"
      - "src/pages/Optimization.tsx (account filtering fix)"
      - "src/components/decks/DecksPanelList.tsx (account filter added)"
      - "src/components/decks/DeckConfigForm.tsx (migrated to PrioritizedAccountSelect)"
      - "src/pages/Decks.tsx, DeckNew.tsx, DeckEditor.tsx (Header added)"
      - "docs/ARCHITECTURE.md (+200 lines: Dual ID System section)"
      - "src/config/version.ts (v2.0.75)"
    deployed: true
    deployment_status: "Pushed to production âœ… (commits e2a1aaa, 9bac8c3)"
    commits:
      - "e2a1aaa: fix: FK constraint violation on optimization creation (v2.0.74)"
      - "9bac8c3: chore: bump version to v2.0.75"
    migrate_to_architecture: true

  - date: "2024-11-03"
    decision: "Fixed gradient display bug in split-layout presentations"
    status: "completed âœ…"
    details: |
      Fixed CSS issue causing gradients to not display correctly in split-layout slides.
      Changed `.slide-split-gradient` from `min-height: 100vh` (viewport-based) to `height: 100%` (parent-based).
      Gradient now fills entire grid cell edge-to-edge without borders.
      Documented in `decks/identities/jumper/design-system.md` and `decks/decks.md`.
    impact: "MEDIUM - Prevents gradient display issues in future presentations"
    files_changed:
      - "decks/output/molduraminuto-report.html (CSS fix applied)"
      - "decks/identities/jumper/design-system.md (troubleshooting section)"
      - "decks/decks.md (troubleshooting section)"
    deployed: false
    deployment_status: "Documentation only (no production deploy needed)"
    migrate_to_architecture: false

# Current issues being worked on
current_issues: []

# Work in progress
work_in_progress: []

# Context for next session
next_session_context: |
  ðŸŽ¯ SESSION 2024-11-05 COMPLETED: DUAL ID SYSTEM FIX + ARCHITECTURE DOCUMENTATION

  ## âœ… WHAT WAS ACCOMPLISHED:

  **1. Critical Bug Fix ðŸš¨**
  - âœ… Fixed FK constraint violation on optimization creation (v2.0.75)
  - âœ… OptimizationNew.tsx now uses notion_id (TEXT) instead of UUID
  - âœ… OptimizationRecorder.tsx typo fixed (selectedAccountName â†’ accountName)
  - âœ… Root cause identified: Dual ID system (UUID for modern, TEXT for legacy tables)

  **2. Architecture Documentation ðŸ“š**
  - âœ… Created comprehensive "Dual ID System" section in ARCHITECTURE.md (~200 lines)
  - âœ… Documented table classification (Modern vs Legacy)
  - âœ… Frontend patterns and common mistakes explained
  - âœ… Migration strategy outlined for future
  - âœ… Decision checklists for developers

  **3. Account Filtering Standardization ðŸ”„**
  - âœ… Fixed /optimization to show ALL accessible accounts (not just with data)
  - âœ… Added account filter to /decks using PrioritizedAccountSelect
  - âœ… Migrated /decks/new to use PrioritizedAccountSelect
  - âœ… Unified account selection pattern across application

  **4. Navigation Headers ðŸ§­**
  - âœ… Added Header component to Decks.tsx, DeckNew.tsx, DeckEditor.tsx
  - âœ… Consistent navigation across all pages

  **5. Context Organization ðŸ“‹**
  - âœ… Migrated old decisions to ARCHITECTURE.md
  - âœ… Cleaned up .claude-context (removed >7 day old items)
  - âœ… Updated deployment status

  ## ðŸŽ¯ CURRENT SYSTEM STATUS:

  **Production:**
  - URL: https://hub.jumper.studio
  - Version: v2.0.75 âœ…
  - Status: All features working, critical bug fixed
  - Last Deploy: 2024-11-05 22:00 UTC
  - Last Commits: e2a1aaa (fix), 9bac8c3 (version bump)

  **What's Working:**
  - âœ… Optimization creation (FK constraint fixed)
  - âœ… Unified account filtering across all pages
  - âœ… Complete navigation (Headers on all pages)
  - âœ… Dual ID system documented and understood

  ## ðŸ“‹ IMPORTANT FOR NEXT SESSION:

  **Dual ID System Pattern (CRITICAL):**
  ```typescript
  // When using PrioritizedAccountSelect with LEGACY tables:
  const handleAccountChange = (accountId: string) => {
    const account = accounts.find(a => a.id === accountId);
    // âœ… Use notion_id for legacy tables (optimizations, creatives)
    setSelectedAccountId(account.notion_id);
    // âŒ DON'T use accountId directly (that's UUID)
  };
  ```

  **Reference:** See `docs/ARCHITECTURE.md` - "Dual ID System" section

  **Dev Credentials (Local):**
  ```
  Email: bruno@jumper.studio
  Password: senha123
  ```

# TODOs pending
pending_todos: []

# Recently completed (for reference)
completed_recently:
  - "âœ… [2024-11-05] Critical FK constraint bug fix (v2.0.75) ðŸš¨"
  - "âœ… [2024-11-05] Dual ID System architecture documentation ðŸ“š"
  - "âœ… [2024-11-05] Account filtering standardization ðŸ”„"
  - "âœ… [2024-11-05] Navigation headers added to Decks pages ðŸ§­"
  - "âœ… [2024-11-03] Gradient display bug fix in presentations ðŸŽ¨"

# Deployment status
deployment:
  production_url: "https://hub.jumper.studio"
  old_url_redirect: "https://ads.jumper.studio â†’ hub.jumper.studio (301)"
  last_deploy: "2024-11-05T22:00:00Z"
  last_deploy_status: "Critical bug fix deployed âœ…"
  last_deploy_type: "bugfix (FK constraint violation)"
  last_commit: "9bac8c3 - chore: bump version to v2.0.75"
  database_status: "STABLE - Dual ID system working correctly âœ…"
  known_issues: "None"
  recent_commits:
    - "9bac8c3: chore: bump version to v2.0.75"
    - "e2a1aaa: fix: FK constraint violation on optimization creation (v2.0.74)"
    - "10d2777: fix: Account filtering + Headers on Decks pages (v2.0.73)"

# Notes for context rotation
context_rotation:
  last_rotation: "2024-11-05"
  next_rotation: "2024-11-12"
  items_migrated_today:
    - "Dual ID System (â†’ ARCHITECTURE.md, new section created)"
    - "Dev-setup agent (>7 days, removed from context)"
    - "Naming standardization (>7 days, already in ARCHITECTURE.md)"
