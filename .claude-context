# Claude Code Context File
# Auto-managed by Claude Code sessions
# Tracks recent decisions and work-in-progress (last 7 days)
# Older decisions migrate to docs/ARCHITECTURE.md

last_updated: "2024-11-05T23:45:00Z"
session_computer: "MacBook Pro (trabalho)"
session_user: "Bruno Maya"

# Recent decisions (last 7 days)
# When older than 7 days, migrate to docs/ARCHITECTURE.md
recent_decisions:
  - date: "2024-11-05"
    decision: "MAJOR RELEASE: Documentation Cleanup + Version v2.1.0"
    status: "completed âœ…"
    details: |
      ðŸ“š DOCUMENTATION CONSOLIDATION + VERSION STRATEGY

      ## Session Summary (2024-11-05 - Part 2):

      ### 1. CLAUDE.md Comprehensive Cleanup

      **User Request:** "REVISE INTEIRAMENTE o claude.md, propondo ajustes e remoÃ§Ãµes de coisas que sÃ£o obsoletas"

      **Audit Results:**
      - Total lines: 1579 (before) â†’ 1288 (after)
      - Reduction: -291 lines (-18%)
      - Issues identified: 8 items (2 CRITICAL, 4 HIGH, 1 MEDIUM, 1 LOW)

      **CRITICAL Fixes Applied:**
      1. âœ… Fixed script paths: `./scripts/` â†’ `./localdev/`
         - Lines 734, 758-788: Updated all script references
      2. âœ… Removed "agent deprecated" incorrect statement
         - Line 98: Changed to "tested and reliable"

      **HIGH Priority Consolidations:**
      3. âœ… Removed duplicate Vercel env vars section (-59 lines)
         - Content already covered in lines 490-687
      4. âœ… Consolidated roadmap sections (-21 lines)
         - Kept overview (lines 29-59), removed detailed duplicate
      5. âœ… Moved Optimization v2.1 technical docs to ARCHITECTURE.md (-123 lines)
         - CLAUDE.md now has reference link only
         - Complete documentation in ARCHITECTURE.md
      6. âœ… Consolidated Local Development sections (-32 lines)
         - Removed duplicate database import instructions

      **MEDIUM Priority Updates:**
      7. âœ… Fixed stale metadata
         - Last Updated: 2024-10-07 â†’ 2024-11-05
         - Project Status updated (FASE 1 âœ…, v2.1 âœ…, REPORTS â³)
         - Fixed typo: 2025-10-09 â†’ 2024-10-09

      ### 2. ARCHITECTURE.md Enhancement

      **Added Optimization v2.1 Section (+126 lines):**
      - Complete component documentation (DateRangePicker, useDraftManager, ContextEditor)
      - Database changes (migration, indexes, constraints)
      - Usage examples and technical decisions
      - Future enhancements roadmap
      - Updated Last Updated: 2024-11-05

      ### 3. Version Strategy Definition

      **User Guidance:**
      "Renomeei a versÃ£o para 2.1 por conta do lanÃ§amento da funcionalidade consolidada de /optimization, estamos saindo de 2.0.x para 2.1.x, sendo que quando o decks estiver ok vamos para 2.2.x"

      **Version Roadmap:**
      - v2.0.x: Optimization system base
      - v2.1.x: âœ… Consolidated optimization functionality (current)
      - v2.2.x: ðŸ”œ Decks system completion (upcoming)

      **v2.1.0 Release Notes:**
      - Documentation cleanup and consolidation
      - CLAUDE.md: -18% (better organization)
      - ARCHITECTURE.md: +126 lines (Optimization v2.1 docs)
      - All technical documentation properly organized

      ### 4. Git Commits

      **Commits Created:**
      ```
      7f8cc71: docs: Major CLAUDE.md cleanup and consolidation
      c03176f: chore: Bump version to v2.1.0 (Documentation Release)
      ```

      **Files Changed:**
      - CLAUDE.md (-291 lines: removed duplicates, fixed paths, updated metadata)
      - docs/ARCHITECTURE.md (+126 lines: Optimization v2.1 section)
      - src/config/version.ts (v2.1.0 + changelog)

      ## Impact: MAJOR - Documentation Organization

      **Before:**
      - 1579 lines in CLAUDE.md (duplications, stale info)
      - Technical details scattered
      - Unclear version strategy

      **After:**
      - âœ… 1288 lines in CLAUDE.md (18% reduction, better organized)
      - âœ… Technical docs in ARCHITECTURE.md (proper location)
      - âœ… Clear version strategy (2.1.x = optimization, 2.2.x = decks)
      - âœ… All metadata updated (dates, status, references)

    impact: "MAJOR - Documentation consolidation + version strategy defined"
    files_changed:
      - "CLAUDE.md (-291 lines: cleanup, consolidation, metadata updates)"
      - "docs/ARCHITECTURE.md (+126 lines: Optimization v2.1 technical docs)"
      - "src/config/version.ts (v2.1.0)"
    deployed: true
    deployment_status: "Pushed to production âœ… (commits 7f8cc71, c03176f)"
    commits:
      - "7f8cc71: docs: Major CLAUDE.md cleanup and consolidation"
      - "c03176f: chore: Bump version to v2.1.0 (Documentation Release)"
    migrate_to_architecture: false
  - date: "2024-11-05"
    decision: "CRITICAL: Dual ID System Fix (UUID vs TEXT notion_id)"
    status: "completed âœ…"
    details: |
      ðŸš¨ CRITICAL BUG FIX: FK constraint violation on optimization creation resolved

      ## Session Summary (2024-11-05):

      ### 1. Problem Discovery

      **User Report:**
      "Claude, provavelmente em virtude dos ajustes que fizemos nessa sessÃ£o, quando tento criar uma nova otimizaÃ§Ã£o dÃ¡ erro permanente."

      **Error Message:**
      ```
      Error: insert or update on table "j_hub_optimization_recordings"
      violates foreign key constraint "j_ads_optimization_recordings_account_id_fkey"

      ReferenceError: selectedAccountName is not defined
      ```

      **Root Cause Investigation:**
      - Commit 412a8ec changed `j_hub_user_accounts` Edge Function to return UUIDs (for decks system)
      - `OptimizationNew.tsx` was storing UUID from `account.id`
      - `j_hub_optimization_recordings.account_id` is TEXT (expects `notion_id`)
      - UUID inserted into TEXT column â†’ FK constraint violation

      **Discovery: Dual ID System**
      - Modern tables (j_hub_decks) use UUID foreign keys
      - Legacy tables (j_hub_optimization_recordings) use TEXT notion_id foreign keys
      - `j_hub_user_accounts` now returns BOTH formats for compatibility

      ### 2. Fix Implementation (v2.0.75)

      **FIX 1: OptimizationNew.tsx (lines 109, 131)**
      ```typescript
      // Before: Stored UUID from PrioritizedAccountSelect
      setSelectedAccountId(accountId); // âŒ UUID in TEXT column

      // After: Extract notion_id from account object
      const account = accounts.find(a => a.id === accountId);
      setSelectedAccountId(account.notion_id); // âœ… TEXT in TEXT column
      ```

      Also fixed `handleRecoverDraft` to search by `a.notion_id` instead of `a.id`.

      **FIX 2: OptimizationRecorder.tsx (line 174)**
      ```typescript
      // Before: ReferenceError
      const accountNameSlug = selectedAccountName.replace(...); // âŒ undefined

      // After: Use correct prop name
      const accountNameSlug = accountName.replace(...); // âœ… defined prop
      ```

      ### 3. Architecture Documentation

      **Created comprehensive ARCHITECTURE.md section:**
      - Overview of dual ID system (UUID vs TEXT)
      - Table classification (Modern vs Legacy)
      - Edge Function compatibility layer
      - Frontend patterns and common mistakes
      - Incident report with symptoms/cause/fix
      - Migration strategy for future
      - Decision checklists

      **Location:** `docs/ARCHITECTURE.md` - "Dual ID System" section

      ### 4. Account Filtering Standardization

      **Problem:** Inconsistent account filtering across pages
      - `/optimization` showed ONLY accounts with optimizations (incorrect)
      - `/decks` had NO account filter
      - `/decks/new` used standard Select instead of PrioritizedAccountSelect

      **Solution:**
      - **PHASE 1:** Fixed `/optimization` to show ALL accessible accounts
      - **PHASE 2:** Added account filter to `/decks` using PrioritizedAccountSelect
      - **PHASE 3:** Migrated `/decks/new` to use PrioritizedAccountSelect

      **Result:** Unified account selection pattern across entire application

      ### 5. Navigation Headers Added

      **Problem:** Decks pages missing Header component

      **Fix:** Added Header and JumperBackground to:
      - `Decks.tsx` (panel view)
      - `DeckNew.tsx` (creation page)
      - `DeckEditor.tsx` (viewer page)

      **Result:** Consistent navigation across all pages

      ### 6. Git Commits

      **Commits Created:**
      ```
      e2a1aaa: fix: FK constraint violation on optimization creation (v2.0.74)
      9bac8c3: chore: bump version to v2.0.75
      ```

      **Files Changed:**
      - `src/pages/OptimizationNew.tsx` (handleAccountChange + handleRecoverDraft fixes)
      - `src/components/OptimizationRecorder.tsx` (selectedAccountName typo fix)
      - `src/config/version.ts` (version bump + changelog)
      - `docs/ARCHITECTURE.md` (new Dual ID System section, ~200 lines)

      ### 7. Context Organization

      **Migrated to ARCHITECTURE.md:**
      - Dual ID System architectural decision (permanent documentation)
      - Table classification and FK patterns
      - Frontend integration patterns

      **Cleaned up `.claude-context`:**
      - Removed decisions >7 days old (dev-setup agent, naming standardization)
      - Kept only recent work (last 3 days)
      - Updated deployment status

      ## Impact: CRITICAL - Production Bug Fix

      **Before:**
      - âŒ Creating new optimizations caused FK constraint errors
      - âŒ Inconsistent account filtering across pages
      - âŒ Missing navigation headers on decks pages

      **After:**
      - âœ… Optimization creation working correctly (v2.0.75 deployed)
      - âœ… Unified account selection pattern everywhere
      - âœ… Complete navigation across all pages
      - âœ… Comprehensive architecture documentation prevents future incidents

    impact: "CRITICAL - Fixed production bug + documented dual ID system architecture"
    files_changed:
      - "src/pages/OptimizationNew.tsx (UUID â†’ notion_id fix)"
      - "src/components/OptimizationRecorder.tsx (typo fix)"
      - "src/pages/Optimization.tsx (account filtering fix)"
      - "src/components/decks/DecksPanelList.tsx (account filter added)"
      - "src/components/decks/DeckConfigForm.tsx (migrated to PrioritizedAccountSelect)"
      - "src/pages/Decks.tsx, DeckNew.tsx, DeckEditor.tsx (Header added)"
      - "docs/ARCHITECTURE.md (+200 lines: Dual ID System section)"
      - "src/config/version.ts (v2.0.75)"
    deployed: true
    deployment_status: "Pushed to production âœ… (commits e2a1aaa, 9bac8c3)"
    commits:
      - "e2a1aaa: fix: FK constraint violation on optimization creation (v2.0.74)"
      - "9bac8c3: chore: bump version to v2.0.75"
    migrate_to_architecture: true

  - date: "2024-11-05"
    decision: "CRITICAL: CLAUDE.md documentation updates (user-requested)"
    status: "completed âœ…"
    details: |
      ðŸš¨ USER-REQUESTED CRITICAL DOCUMENTATION CORRECTIONS

      ## 1. Local Development Setup - Corrected

      **Problem:** CLAUDE.md documented dev-setup agent that didn't work
      **User Feedback:** "o dev setup agent nÃ£o deu certo"

      **Fix Applied:**
      - âŒ Removed entire dev-setup agent section
      - âœ… Documented correct approach: localdev/ scripts
      - âœ… Added 4 scripts documentation (validate, backup, setup, quick-reset)
      - âœ… Interactive menu (./localdev.sh)
      - âœ… Workflows (first time, daily, after migrations)

      ## 2. Decks System - Documented

      **Problem:** Decks feature (v2.0.70) not documented in CLAUDE.md
      **User Request:** "precisamos mencionar na documentaÃ§Ã£o a funÃ§Ã£o decks"

      **Fix Applied:**
      - âœ… New section: "ðŸ“Š Decks System (Presentation Generation)"
      - âœ… Overview, Features, Key Components
      - âœ… Permissions model, Templates, Design Systems
      - âœ… Account Integration examples
      - âœ… Usage examples with code

      ## 3. Account Access Pattern - ABSOLUTE RULE

      **Problem:** No clear mandatory rule about account selection
      **User Emphasis:** "MUITO importante, mencionar que devemos sempre que
      o aplicativo precisar buscar as contas que o usuÃ¡rio tem acesso,
      devemos usar as funÃ§Ãµes padronizadas"

      **User Clarification:** "sempre que precisarmos filtrar as contas do
      usuÃ¡rio, a PrioritizedAccountSelect deve ser usada, SEMPRE. Nunca
      deve ser criado um outro meio ou critÃ©rio."

      **Fix Applied:**
      - âœ… New section: "âš ï¸ CRITICAL: Account Access Pattern"
      - âœ… ðŸš¨ MANDATORY RULE: Always use PrioritizedAccountSelect
      - âœ… âŒ NEVER create alternative selection methods
      - âœ… Stack documentation (Edge Function â†’ Hook â†’ Component)
      - âœ… "DO this / DON'T do this" code examples
      - âœ… Dual ID System awareness (UUID vs TEXT)

      **Why This Is ABSOLUTE:**
      - Enforces permission logic consistency
      - Prevents permission bypass bugs
      - Ensures UI consistency
      - No exceptions allowed

      ## Impact

      **Before:**
      - Incorrect local dev instructions (agent-based)
      - No Decks system documentation
      - No mandatory rule about account selection

      **After:**
      - âœ… Correct local dev setup (localdev/ scripts)
      - âœ… Complete Decks system documentation
      - âœ… ABSOLUTE MANDATORY rule: PrioritizedAccountSelect ALWAYS

    impact: "CRITICAL - Corrected fundamental documentation per user feedback"
    files_changed:
      - "CLAUDE.md (+290 lines, -28 lines: 3 major corrections)"
    deployed: true
    deployment_status: "Documentation pushed âœ… (commit 1f11a18)"
    commits:
      - "1f11a18: docs: Critical updates to CLAUDE.md (localdev, decks, account pattern)"
    migrate_to_architecture: false

  - date: "2024-11-03"
    decision: "Fixed gradient display bug in split-layout presentations"
    status: "completed âœ…"
    details: |
      Fixed CSS issue causing gradients to not display correctly in split-layout slides.
      Changed `.slide-split-gradient` from `min-height: 100vh` (viewport-based) to `height: 100%` (parent-based).
      Gradient now fills entire grid cell edge-to-edge without borders.
      Documented in `decks/identities/jumper/design-system.md` and `decks/decks.md`.
    impact: "MEDIUM - Prevents gradient display issues in future presentations"
    files_changed:
      - "decks/output/molduraminuto-report.html (CSS fix applied)"
      - "decks/identities/jumper/design-system.md (troubleshooting section)"
      - "decks/decks.md (troubleshooting section)"
    deployed: false
    deployment_status: "Documentation only (no production deploy needed)"
    migrate_to_architecture: false

# Current issues being worked on
current_issues: []

# Work in progress
work_in_progress: []

# Context for next session
next_session_context: |
  ðŸŽ¯ SESSION 2024-11-05 COMPLETED: DOCUMENTATION CONSOLIDATION + VERSION v2.1.0

  ## âœ… WHAT WAS ACCOMPLISHED TODAY:

  **PART 1: Critical Bug Fixes (Morning)**
  - âœ… Fixed FK constraint violation on optimization creation (v2.0.75)
  - âœ… Dual ID System documented in ARCHITECTURE.md (~200 lines)
  - âœ… Account filtering standardized across all pages
  - âœ… Navigation headers added to Decks pages

  **PART 2: Documentation Cleanup (Evening)**
  - âœ… CLAUDE.md comprehensive cleanup: 1579 â†’ 1288 lines (-18%)
  - âœ… Fixed script paths (./scripts/ â†’ ./localdev/)
  - âœ… Removed duplicates (Vercel env vars, roadmap, Local Dev)
  - âœ… Moved Optimization v2.1 technical docs to ARCHITECTURE.md
  - âœ… Updated all stale metadata (dates, status)
  - âœ… Version bump to v2.1.0 (Documentation Release)

  ## ðŸŽ¯ CURRENT SYSTEM STATUS:

  **Production:**
  - URL: https://hub.jumper.studio
  - Version: v2.1.0 âœ… (Documentation Release)
  - Status: All features working, documentation organized
  - Last Deploy: 2024-11-05 23:45 UTC
  - Last Commits: 7f8cc71 (docs cleanup), c03176f (v2.1.0)

  **What's Working:**
  - âœ… Optimization creation (FK constraint fixed)
  - âœ… Unified account filtering across all pages
  - âœ… Complete navigation (Headers on all pages)
  - âœ… Documentation consolidated and organized

  **Version Strategy:**
  - v2.0.x: Optimization system base
  - v2.1.x: âœ… Consolidated optimization functionality (CURRENT)
  - v2.2.x: ðŸ”œ When decks system is complete

  ## ðŸ“‹ IMPORTANT FOR NEXT SESSION:

  **Dual ID System Pattern (CRITICAL):**
  ```typescript
  // When using PrioritizedAccountSelect with LEGACY tables:
  const handleAccountChange = (accountId: string) => {
    const account = accounts.find(a => a.id === accountId);
    // âœ… Use notion_id for legacy tables (optimizations, creatives)
    setSelectedAccountId(account.notion_id);
    // âŒ DON'T use accountId directly (that's UUID)
  };
  ```

  **Key References:**
  - Dual ID System: `docs/ARCHITECTURE.md` - "Dual ID System" section
  - Optimization v2.1: `docs/ARCHITECTURE.md` - "Optimization Creation Flow v2.1" section
  - Local Dev: Use `./localdev.sh` interactive menu or numbered scripts

  **Dev Credentials (Local):**
  ```
  Email: bruno@jumper.studio
  Password: senha123
  ```

  **Next Focus:** Decks system completion â†’ v2.2.x release

# TODOs pending
pending_todos: []

# Recently completed (for reference)
completed_recently:
  - "âœ… [2024-11-05 23:45] Version v2.1.0 release (Documentation consolidation) ðŸ“¦"
  - "âœ… [2024-11-05 23:40] CLAUDE.md cleanup: -291 lines (-18%) ðŸ“š"
  - "âœ… [2024-11-05 23:30] CRITICAL documentation updates (user-requested) ðŸ“š"
  - "âœ… [2024-11-05 22:00] Dual ID System â†’ ARCHITECTURE.md migration ðŸ“‹"
  - "âœ… [2024-11-05 22:00] Critical FK constraint bug fix (v2.0.75) ðŸš¨"
  - "âœ… [2024-11-05 22:00] Account filtering standardization ðŸ”„"
  - "âœ… [2024-11-05 22:00] Navigation headers added to Decks pages ðŸ§­"
  - "âœ… [2024-11-03] Gradient display bug fix in presentations ðŸŽ¨"

# Deployment status
deployment:
  production_url: "https://hub.jumper.studio"
  old_url_redirect: "https://ads.jumper.studio â†’ hub.jumper.studio (301)"
  last_deploy: "2024-11-05T23:45:00Z"
  last_deploy_status: "v2.1.0 Documentation Release deployed âœ…"
  last_deploy_type: "major (documentation consolidation + version strategy)"
  last_commit: "c03176f - chore: Bump version to v2.1.0 (Documentation Release)"
  database_status: "STABLE - All systems operational âœ…"
  known_issues: "None"
  recent_commits:
    - "c03176f: chore: Bump version to v2.1.0 (Documentation Release)"
    - "7f8cc71: docs: Major CLAUDE.md cleanup and consolidation"
    - "1f11a18: docs: Critical updates to CLAUDE.md (localdev, decks, account pattern)"
    - "9b38025: docs: Migrate Dual ID System to ARCHITECTURE.md + context cleanup"
    - "9bac8c3: chore: bump version to v2.0.75"
    - "e2a1aaa: fix: FK constraint violation on optimization creation (v2.0.74)"

# Notes for context rotation
context_rotation:
  last_rotation: "2024-11-05"
  next_rotation: "2024-11-12"
  items_migrated_today:
    - "Optimization v2.1 technical docs (â†’ ARCHITECTURE.md, +126 lines)"
    - "Dual ID System (â†’ ARCHITECTURE.md, new section created)"
    - "Dev-setup agent (>7 days, removed from context)"
    - "Naming standardization (>7 days, already in ARCHITECTURE.md)"
  documentation_improvements:
    - "CLAUDE.md: 1579 â†’ 1288 lines (-18% reduction)"
    - "Removed duplicates: Vercel env vars, roadmap, Local Dev sections"
    - "Fixed all script paths: ./scripts/ â†’ ./localdev/"
    - "Updated all stale metadata (dates, status, references)"
    - "Version strategy defined: 2.1.x = optimization, 2.2.x = decks"
