# ğŸš§ Roadmap: Decks 3-Stage Interactive Architecture

**Status:** ğŸ”„ Em Progresso (Phase 1 completa)
**InÃ­cio:** 2025-01-12
**Objetivo:** Migrar Decks para arquitetura interativa 3-stage (modelo Optimizations)

---

## ğŸ¯ Problema a Resolver

**SituaÃ§Ã£o Atual:**
- âŒ GeraÃ§Ã£o monolÃ­tica (analyze + generate em 1 chamada)
- âŒ Timeouts frequentes (>2.5 minutos, HTTP 504)
- âŒ HTML incompleto (max_tokens insuficiente)
- âŒ Sem visibilidade do processo para usuÃ¡rio
- âŒ Debugging difÃ­cil (sem logs intermediÃ¡rios)

**SoluÃ§Ã£o: 3-Stage Workflow** (inspirado em Optimizations)

---

## ğŸ“ Arquitetura Target

### **STAGE 1: Content Analysis** âœ… (jÃ¡ funciona)
- **Edge Function:** `j_hub_deck_analyze`
- **Input:** `markdown_source`, `deck_type`, `template_id`
- **Output:** `generation_plan` (JSON com 9 slides + pattern recommendations)
- **Status:** `analysis_status` (pending â†’ processing â†’ completed/failed)
- **Tempo:** ~17s
- **DB Update:** Salva `generation_plan` em `j_hub_decks.generation_plan`

### **STAGE 2: Plan Review** ğŸ”„ (auto-approved por enquanto)
- **Edge Function:** Nenhuma (future: `j_hub_deck_review`)
- **Input:** `generation_plan` do Stage 1
- **Output:** Approved/edited plan
- **Status:** `review_status` (auto = 'completed')
- **Tempo:** InstantÃ¢neo
- **Future:** Modal para usuÃ¡rio editar patterns antes de gerar HTML

### **STAGE 3: HTML Generation** ğŸ”„ (refatorar para usar plan do DB)
- **Edge Function:** `j_hub_deck_generate` (refatorar)
- **Input:** `approved_plan`, `markdown_source`, `template_css`
- **Output:** `html_output`, `file_url` (Storage)
- **Status:** `generation_status` (pending â†’ processing â†’ completed/failed)
- **Tempo:** ~2-3min (aceitÃ¡vel sem timeout do frontend)
- **DB Update:** Salva HTML e URL

---

## ğŸ—„ï¸ Database Schema (NEW)

### **Colunas Adicionadas em `j_hub_decks`:**

```sql
analysis_status TEXT DEFAULT 'pending'     -- Stage 1 status
review_status TEXT DEFAULT 'pending'       -- Stage 2 status (auto-approved)
generation_status TEXT DEFAULT 'pending'   -- Stage 3 status
```

**Status values:** `'pending'` | `'processing'` | `'completed'` | `'failed'`

### **Nova Tabela: `j_hub_deck_api_logs`**

```sql
CREATE TABLE j_hub_deck_api_logs (
  id UUID PRIMARY KEY,
  deck_id UUID REFERENCES j_hub_decks(id),
  stage TEXT,                    -- 'analysis' | 'generation'
  prompt_sent TEXT,              -- Full prompt for debugging
  response_received TEXT,        -- Full response
  tokens_used JSONB,             -- {input: N, output: M, total: X}
  latency_ms INTEGER,
  model_used TEXT,
  success BOOLEAN,
  error_message TEXT,
  created_at TIMESTAMPTZ
);
```

**Purpose:** Audit trail para debugging (ver prompts, responses, tokens)

---

## ğŸ¨ Frontend Architecture (NEW)

### **Nova PÃ¡gina: `/decks/editor/[id]`**

**Baseada em:** `src/pages/OptimizationEditor.tsx`

**Layout (reverse display - top = most refined):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¨ DECK PREVIEW (Stage 3)              â”‚  â† Top (most refined)
â”‚  Status: â³ Aguardando Stages 1 e 2     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [Iframe com HTML gerado]       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  [ğŸ”„ Regerar HTML] [â¬‡ï¸ Download]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ SLIDE PLAN (Stage 2)                â”‚  â† Middle (structured)
â”‚  Status: âœ… Auto-aprovado               â”‚
â”‚  â€¢ Slide 1: hero-slide (Capa)          â”‚
â”‚  â€¢ Slide 2: content-slide (SumÃ¡rio)    â”‚
â”‚  â€¢ Slide 3: timeline (EvoluÃ§Ã£o)        â”‚
â”‚  â€¢ ... (9 slides total)                â”‚
â”‚  â€¢ Pattern diversity: 89%              â”‚
â”‚  [âœï¸ Editar Plano] [âœ… Aprovar]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” CONTENT ANALYSIS (Stage 1)          â”‚  â† Bottom (raw input)
â”‚  Status: âœ… Completo (17s)              â”‚
â”‚  â€¢ Markdown: 805 chars                  â”‚
â”‚  â€¢ Tipo: report                         â”‚
â”‚  â€¢ Template: koko-classic               â”‚
â”‚  [ğŸ”„ Reanalisar]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Components NecessÃ¡rios:**

1. **`DeckEditorStepCard.tsx`** (baseado em `OptimizationStepCard`)
   - Props: `step`, `status`, `data`, `onRegenerate`, `onEdit`
   - Features: Collapsible, status badge, action buttons
   - States: pending (locked) â†’ processing (spinner) â†’ completed (unlocked)

2. **`PlanReviewModal.tsx`** (Stage 2 editing)
   - Lista 9 slides com pattern dropdown
   - BotÃ£o "Aprovar e Gerar HTML"
   - Valida diversity score

3. **`DeckPreviewIframe.tsx`** (Stage 3 preview)
   - Iframe com HTML gerado
   - Fullscreen toggle
   - Download button

---

## ğŸ”„ Fluxo de CriaÃ§Ã£o (NEW)

### **1. Upload Markdown** (Entry Point)

```
User: /decks â†’ Click "Novo Deck"
Frontend: Modal pede tÃ­tulo, tipo, markdown
Action: POST /api/decks
Backend: Cria record com analysis_status='pending'
Response: { deck_id }
Redirect: /decks/editor/[deck_id]
```

### **2. Stage 1 - Content Analysis**

```
Frontend: DeckEditorStepCard(1) shows "pending"
User: Click "Analisar ConteÃºdo" (auto-trigger on mount)
Action: POST /functions/v1/j_hub_deck_analyze
Backend:
  1. SET analysis_status = 'processing'
  2. Call Claude Sonnet (~17s)
  3. Save generation_plan to DB
  4. Log API call to j_hub_deck_api_logs
  5. SET analysis_status = 'completed'
Frontend: Poll deck status â†’ Update card to "completed"
```

### **3. Stage 2 - Plan Review** (Auto-approved for now)

```
Frontend: DeckEditorStepCard(2) unlocks automatically
Backend: Auto-set review_status = 'completed'
Future: User opens PlanReviewModal, edits patterns, clicks "Aprovar"
```

### **4. Stage 3 - HTML Generation**

```
Frontend: DeckEditorStepCard(3) unlocks
User: Click "Gerar ApresentaÃ§Ã£o"
Action: POST /functions/v1/j_hub_deck_generate
Backend:
  1. SET generation_status = 'processing'
  2. Load approved_plan from DB
  3. Call Claude Sonnet (~2-3min)
  4. Generate HTML (16K max_tokens)
  5. Upload to Storage
  6. Save file_url to DB
  7. Log API call
  8. SET generation_status = 'completed'
Frontend: Poll deck status â†’ Update card + show preview
```

---

## âœ… Progress Tracker

### **Phase 1: Database & Backend** (Estimado: 1-2h) âœ… 70% Complete

- [x] **1.1** Create migration: Add stage status columns âœ…
- [x] **1.2** Create `j_hub_deck_api_logs` table âœ…
- [x] **1.3** Refactor `j_hub_deck_generate`: Remove Stage 1 call âœ…
- [x] **1.4** Update `j_hub_deck_generate`: Read plan from DB âœ…
- [x] **1.5** Add API logging to `j_hub_deck_generate` âœ…
- [ ] **1.6** Add API logging to `j_hub_deck_analyze` (simple update)
- [ ] **1.7** Test Stages via curl (validation)

### **Phase 2: Frontend Core** (Estimado: 2-3h)

- [ ] **2.1** Create `/src/pages/DeckEditorPage.tsx` skeleton
- [ ] **2.2** Create `/src/components/decks/DeckEditorStepCard.tsx`
- [ ] **2.3** Add status polling with React Query
- [ ] **2.4** Wire Stage 1 button (analyze)
- [ ] **2.5** Wire Stage 3 button (generate)
- [ ] **2.6** Test Stage 1 â†’ Stage 3 flow

### **Phase 3: Polish & UX** (Estimado: 1-2h)

- [ ] **3.1** Create `PlanReviewModal.tsx` (Stage 2 UI)
- [ ] **3.2** Add `DeckPreviewIframe` component
- [ ] **3.3** Add edit/regenerate buttons
- [ ] **3.4** Add loading states and error handling
- [ ] **3.5** Test full E2E flow
- [ ] **3.6** Update `/decks` list page to link to new editor

---

## ğŸ”§ Refactoring Details

### **Edge Function: `j_hub_deck_generate/index.ts`**

#### **BEFORE (monolithic):**
```typescript
serve(async (req) => {
  // Stage 1: Call j_hub_deck_analyze
  const analyzeResponse = await fetch(...);

  // Stage 2: Auto-approve
  const approvedPlan = plan;

  // Stage 3: Generate HTML
  const claudeResponse = await fetch(...);
});
```

#### **AFTER (Stage 3 only):**
```typescript
serve(async (req) => {
  const { deck_id } = await req.json();

  // Load approved plan from DB
  const { data: deck } = await supabase
    .from('j_hub_decks')
    .select('generation_plan, markdown_source, template_id')
    .eq('id', deck_id)
    .single();

  if (!deck.generation_plan) {
    throw new Error('Stage 1 not completed');
  }

  // Update status
  await supabase
    .from('j_hub_decks')
    .update({ generation_status: 'processing' })
    .eq('id', deck_id);

  // Stage 3: Generate HTML
  const claudeResponse = await fetchWithRetry(...);

  // Save result
  await supabase
    .from('j_hub_decks')
    .update({
      html_output: htmlOutput,
      file_url: publicUrl,
      generation_status: 'completed'
    })
    .eq('id', deck_id);

  // Log API call
  await supabase
    .from('j_hub_deck_api_logs')
    .insert({
      deck_id,
      stage: 'generation',
      tokens_used: claudeData.usage,
      success: true
    });
});
```

### **Edge Function: `j_hub_deck_analyze/index.ts`**

#### **ADD: Status updates + API logging**
```typescript
serve(async (req) => {
  const { deck_id, markdown_source, deck_type, template_id } = await req.json();

  // Update status
  await supabase
    .from('j_hub_decks')
    .update({ analysis_status: 'processing' })
    .eq('id', deck_id);

  // ... existing analysis logic ...

  // Save result
  await supabase
    .from('j_hub_decks')
    .update({
      generation_plan: plan,
      analysis_status: 'completed'
    })
    .eq('id', deck_id);

  // Log API call
  await supabase
    .from('j_hub_deck_api_logs')
    .insert({
      deck_id,
      stage: 'analysis',
      tokens_used: claudeData.usage,
      success: true
    });
});
```

---

## ğŸš¨ DecisÃµes Pendentes

### **1. Stage 2 Review UI**
- **OpÃ§Ã£o A:** Implementar agora (full modal com ediÃ§Ã£o de patterns)
- **OpÃ§Ã£o B:** Deixar auto-approved, implementar depois
- **RecomendaÃ§Ã£o:** OpÃ§Ã£o B (iterar rÃ¡pido, adicionar UI depois)

### **2. API Logs Retention**
- **Pergunta:** Quanto tempo manter logs?
- **RecomendaÃ§Ã£o:** 30 dias (adicionar cronjob de limpeza)

### **3. Feature Flag**
- **Pergunta:** Manter fluxo antigo em paralelo?
- **RecomendaÃ§Ã£o:** Sim, flag `USE_NEW_DECK_EDITOR` (env var)

### **4. Error Handling**
- **Pergunta:** O que fazer se Stage 1 falhar?
- **RecomendaÃ§Ã£o:** Status = 'failed', botÃ£o "Tentar Novamente"

---

## ğŸ“Š Expected Benefits

| Aspecto | Antes | Depois |
|---------|-------|--------|
| **Timeout** | 5+ min (falha) | 3 stages Ã— 3min (sucesso) |
| **Debugging** | âŒ Black box | âœ… Logs por stage |
| **User Control** | âŒ Zero | âœ… Edit/review entre stages |
| **HTML Quality** | âš ï¸ Incompleto (8K tokens) | âœ… Completo (16K tokens) |
| **Visibilidade** | âŒ Loading spinner | âœ… Progress por stage |
| **Retry** | âŒ Refaz tudo | âœ… Retry sÃ³ stage que falhou |

---

## ğŸ”— Reference Files

**Optimizations (model to follow):**
- `src/pages/OptimizationEditor.tsx`
- `src/components/optimization/OptimizationStepCard.tsx`
- `supabase/functions/j_hub_optimization_*/`

**Decks (files to modify/create):**
- `supabase/functions/j_hub_deck_analyze/index.ts` (add status updates)
- `supabase/functions/j_hub_deck_generate/index.ts` (refactor to Stage 3 only)
- `src/pages/DeckEditorPage.tsx` (NEW)
- `src/components/decks/DeckEditorStepCard.tsx` (NEW)

---

## ğŸ“ Notes & Learnings

### **2025-01-12 - Session 1**
- âœ… Migration criada e aplicada em produÃ§Ã£o
- âœ… Database pronto para 3-stage workflow
- ğŸ”„ PrÃ³ximo: Refatorar Edge Functions para usar novos status
- âš ï¸ HTML atual com encoding UTF-8 corrompido (needs fix)
- âš ï¸ max_tokens=8K insuficiente, voltamos para 16K

### **Key Insights from Optimizations:**
1. **Reverse Display** (refined â†’ raw) reduz carga cognitiva
2. **Status-driven UI** evita race conditions
3. **API Logs table** Ã© CRÃTICO para debugging
4. **Versioning** permite undo (implementar depois)
5. **Auto-collapse** para step mais completo melhora UX

---

**ğŸ¯ Next Session Start Here:**
- Continue Phase 1.3: Refactor `j_hub_deck_generate`
- Remove Stage 1 call, load plan from DB
- Add status updates and API logging
